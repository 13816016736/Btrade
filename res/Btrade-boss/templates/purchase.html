{% extends "base.html" %}
{% block container %}
{% import config %}
<div class="content-wrapper">
    <section class="content-header">
        <h1>订单管理</h1>
    </section>
    <section class="filter">
        <form class="form-inline">
            <div class="form-group">
                <a href="/purchase/purchaselist?type=-1&starttime={{starttime}}&endtime={{endtime}}"><span class="label {% if int(type) < 0%}label-warning{%else%}label-default{%end%}">全部（{{stat.get(0,0) + stat.get(1,0) + stat.get(3,0)}}）</span></a>
            </div>
            <div class="form-group">
                <a href="/purchase/purchaselist?type=1&starttime={{starttime}}&endtime={{endtime}}"><span class="label {% if int(type) == 1%}label-warning{%else%}label-default{%end%}">进行中（{{stat.get(1,0)}}）</span></a>
            </div>
            <div class="form-group">
                <a href="/purchase/purchaselist?type=0&starttime={{starttime}}&endtime={{endtime}}"><span class="label {% if int(type) == 0%}label-warning{%else%}label-default{%end%}">关闭（{{stat.get(0,0)}}）</span></a>
            </div>
            <div class="form-group">
                <label >发布时间：</label>
                <div class="input-group date form_datetime">
                    <div class="input-group-addon">
                        <i class="fa fa-calendar"></i>
                    </div>
                    <input type="text" class="form-control" id="starttime" value="{{starttime}}">
                </div>
                至
                <div class="input-group date form_datetime">
                    <div class="input-group-addon">
                        <i class="fa fa-calendar"></i>
                    </div>
                    <input type="text" class="form-control" id="endtime" value="{{endtime}}">
                </div>
            </div>
            <div class="form-group">
                <input class="form-control" id="query" size="80" name="query" placeholder="品种名" type="text" value="{% if query %}{{query}}{% end %}">
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-primary btn-query" id="pquery">查询</button>
            </div>
            <div class="form-group">
                <button type="reset" class="btn btn-default">清空</button>
            </div>
        </form>
    </section>
    <section class="content">
        <div class="mychart mychart-m">
            <table class="tc">
                <thead>
                    <tr>
                        <th>品种</th>
                        <th>报价</th>
                        <th width="100">操作</th>
                    </tr>
                </thead>
                <tfoot></tfoot>
                {% for purchase in purchases%}
                    <tbody>
                        <tr>
                            <td class="space" colspan="3"></td>
                        </tr>
                        <tr>
                            <td colspan="3" class="th">
                                <div class="hd">
                                    <span><em class="gray">采购批号：</em>{{ purchase.id }}</span>
                                    <span class="company">{{ purchase.name }}</span>
                                    <span><em class="gray">发布时间：</em>{{ purchase.datetime }}</span>
                                    {% if purchase.status == 0%}
                                    <span class="status-closed">关闭</span>
                                    {% elif (purchase.term != 0 and purchase.has_key("timedelta") and purchase.timedelta > 0) or purchase.term == 0%}
                                    <span class="status-wait">等待报价
                                        {% if purchase.term != 0%}
                                        <em class="gray">剩余{{purchase.timedelta}}天（{{purchase.expire}} 截止）</em>
                                        {% else%}
                                        <em class="status-sustain">常年采购</em>
                                        {% end %}
                                    </span>
                                    {% else %}
                                    <span class="status-finish">报价结束，甄选供应商</span>
                                    {% end %}

                                    {% if purchase.status == 0 %}
                                    <!--<span class="glyphicon glyphicon-list-alt" style="color:#f0ad4e;"></span>-->
                                    {% elif (purchase.term != 0 and purchase.has_key("timedelta") and purchase.timedelta > 0) or purchase.term == 0%}
                                    <i class="glyphicon glyphicon-remove-sign jclose" onclick="removepurchase({{purchase.id}})" title="关闭采购单"></i>
                                    {% else %}
                                    <!--<span class="glyphicon glyphicon-list-alt" style="color:#f0ad4e;"></span>-->
                                    {% end %}
                                    <i class="fa fa-angle-down expand" title="展开详情"></i>
                                </div>
                                <div class="info">
                                    <p><span>交货地：</span>
                                        {% if purchase.position %}{{purchase.position}}{% end %}</p>
                                    <p><span>发票要求：</span>
                                        {% if purchase.invoice == 1 %}
                                        无需发票
                                        {% elif purchase.invoice == 2 %}
                                        普通发票
                                        {% elif purchase.invoice == 3 %}
                                        增值税发票
                                        {% end %}</p>
                                    <p><span>交易及付款：</span>
                                        {% if purchase.pay == 1 %}
                                        预付全款
                                        {% elif purchase.pay == 2 %}
                                        双方直接交易，验收合格后{{purchase.payday}}天内付款
                                        {% elif purchase.pay == 3 %}
                                        {{purchase.payinfo}}
                                        {% end %}</p>
                                    <p><span>验收及包装：</span>
                                        {{purchase.accept}}</p>
                                    <p><span>寄样：</span>
                                        {% if purchase.send == 1 %}
                                        报价必须寄样
                                        {% end %}
                                        {{purchase.receive}}</p>
                                    <p><span>补充说明：</span>
                                        {{purchase.other}}</p>
                                    <p><span>供应商要求：</span>
                                        {% if purchase.supplier == 1 %}
                                        必须有营业执照（公司/合作社/经营户），不接受个人
                                        {% elif purchase.supplier == 2 %}
                                        具备GSP资质
                                        {% elif purchase.supplier == 3 %}
                                        具备GMP资质
                                        {% end %}</p>
                                </div>

                            </td>
                        </tr>
                        {% for index,purchaseinfo in enumerate(purchase.purchaseinfo)%}
                        <tr>
                            <td class="tl">
                                <span><a href="/purchase/purchaseinfo/{{purchaseinfo.id}}">{{purchaseinfo.name}}</a></span>
                                <span>{{purchaseinfo.specification}}</span>
                            </td>
                            <td class="tl">
                                {{purchaseinfo.quotecount}}个报价{% if purchaseinfo.unread > 0 %}（<b>{{purchaseinfo.unread}}</b>个未回复）{% end %}
                                {% if purchaseinfo.intentions > 0 %}
                                <span class="status-accept">已甄选<b>{{purchaseinfo.intentions}}</b>家意向供应商</span>
                                {% end %}
                            </td>
                            <td>
                                {% if (purchase.term != 0 and purchase.has_key("timedelta") and purchase.timedelta > 0) or purchase.term == 0%}
                                <span class="glyphicon glyphicon-share" rel="{{purchaseinfo.id}}" sharerel="{{purchase.name}}采购{{purchaseinfo.name}}{{purchaseinfo.quantity}}{{purchaseinfo.unit}}，{{purchaseinfo.specification}}，产地{{purchaseinfo.origin}}，{{purchaseinfo.quality}}。请速报价：{{config.host}}/purchase/purchaseinfo/{{purchaseinfo.id}}" style="color:#f0ad4e;"></span>&nbsp;&nbsp;
                                <span class="glyphicon glyphicon-list-alt" rel="{{purchaseinfo.id}}" purchaser="{{purchase.name}}" sharerel="【药材购】{{purchase.name}}采购{{purchaseinfo.name}}（{{purchaseinfo.specification}}）{{purchaseinfo.quantity}}{{purchaseinfo.unit}}。邀请您立即报价：{{config.host}}/purchase/purchaseinfo/{{purchaseinfo.id}} 退订回T" style="color:#f0ad4e;"></span>&nbsp;&nbsp;
                                {% end %}
                            </td>
                        </tr>
                        {% end %}
                    </tbody>
                {% end %}
            </table>
        </div>
        {% module PageNav(nav=nav, show=True) %}
    </section>
</div>
<!-- Modal -->
<div class="modal fade" id="share" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">邀请报价</h4>
      </div>
      <div class="modal-body">
        <div class="row">
            <div class="col-sm-6">
                <div class="bs-example">
                    <h5><img width="30" src="{{ static_url('images/wechat.jpg') }}" />  微信邀请朋友报价</h5>
                    <p>微信扫描如下二维码，可发给微信好友或分享朋友圈，邀请前来报价</p>
                    <center><img id="qrcode" src="" width="180"/></center>
                </div>
            </div>
            <div class="col-sm-6">
                <h5><img width="30" src="{{ static_url('images/qq.jpg') }}" />  QQ邀请朋友报价</h5>
                <p>复制如下消息，发送给QQ好友或QQ群，邀请其前来报价</p>
                <textarea id="sharemsg" class="form-control" style="width: 250px; height: 100px;" placeholder=""></textarea>
                <br>
                <button style="width:250px" type="button" class="btn btn-default">复制</button>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal -->
<div class="modal fade" id="sendx" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="mysendModalLabel">邀请报价</h4>
      </div>
      <div class="modal-body">
        <center>
        <h5><img width="30" src="{{ static_url('images/phone.jpg') }}" />  短信群发通知供应商报价</h5>
        <textarea id="content" class="form-control" style="width: 500px; height: 100px;" placeholder="" readonly="readonly"></textarea>
        <br>
        <input type="hidden" id="purchaseinfoid" name="purchaseinfoid">
        <input type="hidden" id="purchaser" name="purchaser">
        <button style="width:250px" type="button" class="btn btn-default" id="sendsms">发送</button>
        </center>
      </div>
    </div>
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    $(".form_datetime").datetimepicker({
                language: "zh-CN",
                autoclose: true,
                todayBtn: true
            });

    $(".glyphicon-share").click(function() {
        var id = $(this).attr('rel');
        var qrcode = "http://qr.liantu.com/api.php?text={{config.host}}/purchase/purchaseinfo/"+id;
        var share = $(this).attr('sharerel');
        $("#sharemsg").attr("placeholder", share);
        $("#sharemsg").html(share);
        $("#qrcode").attr("src",qrcode)
        $("#share").modal();
    });

    $(".glyphicon-list-alt").click(function() {
        $("#sendsms").html("发送");
        $("#sendsms").removeAttr("disabled");
        var id = $(this).attr('rel');
        var purchaser = $(this).attr('purchaser');
        var share = $(this).attr('sharerel');
        $("#purchaseinfoid").val(id);
        $("#purchaser").val(purchaser);
        $("#content").html(share);
        $("#sendx").modal();
    });

    $("#sendsms").click(function() {
        $(this).html("正在发送");
        $(this).attr('disabled',"true");
        $.ajax({
            url: "/pushpurchase",
            data: "purchaseinfoid="+$("#purchaseinfoid").val()+"&purchaser="+$("#purchaser").val(),
            dataType: 'json',
            type: 'POST',
            beforeSend: function(jqXHR, settings) {
                jqXHR.setRequestHeader('X-Xsrftoken', document.cookie.match("\\b_xsrf=([^;]*)\\b")[1]);
            },
            success: function(data) {
                if(data.status == "success"){
                    //console.log(123);
                    $("#sendsms").html(data.message);
                    //$("#sendsms").removeAttr("disabled");
                }else{
                    $("#sendsms").html(data.message);
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                //console.log(errorThrown);
                 alert(errorThrown);
            }
         });
    });

    $("#pquery").click(function(){
        var starttime = $("#starttime").val();
        var endtime = $("#endtime").val();
        var query = $("#query").val();
        if ((starttime != "" && endtime != "") || query !="") {
            window.location.href=encodeURI('/purchase/purchaselist?type={{type}}&starttime='+starttime+'&endtime='+endtime+'&query='+query);
        }else{
            alert("时间范围或品种名需填写完整");
        }
    });

    // 展开
    $('.mychart-m').on('click', '.th', function() {
        $(this).find('.info').slideToggle();
        $(this).find('.expand').toggleClass('fa-angle-down').toggleClass('fa-angle-up');
    })
})

function removepurchase(pid){
    if(!confirm('确定要关闭当前采购订单？'))return false;
    $.ajax({
        url: "/removepurchase",
        data: "pid="+pid,
        dataType: 'json',
        type: 'POST',
        beforeSend: function(jqXHR, settings) {
            jqXHR.setRequestHeader('X-Xsrftoken', document.cookie.match("\\b_xsrf=([^;]*)\\b")[1]);
        },
        success: function(data) {
            if(data.status == "success"){
                window.location.reload();
            }else{
                alert("提交失败，请刷新页面重试");
            }
        },
        error: function(XMLHttpRequest, textStatus, errorThrown) {
            //console.log(errorThrown);
            alert(errorThrown);
        }
     });
}
</script>
{% end %}
