{% extends "basenofoot.html" %}
{% block container %}
{% import time %}
{% raw xsrf_form_html() %}
<header class="yc-header">
    <div class="yc-header-back">
        <a href="javascript:history.back();">
            <i class="iconfont icon-back"></i>
        </a>
    </div>
    <div class="yc-header-title">我的采购</div>
</header><!-- /yc-header -->

<section class="yc-content">
    <div class="yc-sub-title">
        <span>共发布<b>{{len(purchaseinfos)}}</b>个采购批次，收到<b>{{len(quotes)}}</b>个报价</span>
    </div>
    <div class="yc-reply-list">
        <ul>

        </ul>
    </div>

</section><!-- /yc-content -->

<!-- 删除 -->
<div class="modal yc-modal" id="jModalDelete" tabindex="-1" role="dialog" aria-labelledby="tit1">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="tit1">关闭采购单</h4>
            </div>
            <div class="modal-body">
                <div class="confirm">
                    <strong>您确认要关闭此采购单吗？</strong>
                </div>
                <div class="button">
                    <input id="pid" type="hidden" name="pid" value=""/>
                    <button type="button" class="btn btn-warning">关闭采购单</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 删除成功提示 -->
<div class="modal yc-modal" id="jModalDeleteResult" tabindex="-1" role="dialog" aria-labelledby="tit2">
    <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="tit2">关闭采购单</h4>
            </div>
            <div class="modal-body">
                <div class="result">
                    <p class="success"><i class="iconfont icon-radio-yes"></i>操作成功</p>
                    <p class="tips">3秒后自动关闭</p>
                </div>
                <div class="button">
                    <button type="button" class="btn btn-default" data-dismiss="modal">立即关闭</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="{{ static_url('js/jquery.min.js') }}"></script>
<script src="{{ static_url('js/bootstrap.min.js') }}"></script>
<script src="{{ static_url('js/app.js') }}"></script>
<script>
$(function() {
    var $jModalDelete = $('#jModalDelete');
    var timer = 0;
    var isDel = false;
    // 关闭整个采购单
    $('.yc-reply-list').on('click', '.tools .fl', function() {
        $("#pid").val($(this).attr("pid"));
        var txt = '<p>确认对如下采购单停止报价？停止后，该批次的所有的品种都将停止报价</p>';
        var $pa = $(this).closest('li').find('dd>a');
        var tags = [];
        $pa.each(function() {
            tags.push($(this).find('.w1').html());
        });

        txt += '<strong>' + tags.join('、') + '</strong>';

        $jModalDelete.find('.confirm').html(txt);
        $jModalDelete.modal();
        return false;
    });

    $jModalDelete.on('hidden.bs.modal', function() {
        if (isDel) {
            $('#jModalDeleteResult').modal('show');
            timer && clearTimeout(timer);
            timer = setTimeout(function() {
                $('#jModalDeleteResult').modal('hide');
            }, 3e3);
        }
        isDel = false;
    });

    $jModalDelete.on('click', '.btn', function() {
        $.ajax({
            url: '/removepurchase',
            data: {pid:$("#pid").val()},
            type: 'post',
            dataType: 'json',
            beforeSend: function(jqXHR, settings) {
                jqXHR.setRequestHeader('X-Xsrftoken', document.cookie.match("\\b_xsrf=([^;]*)\\b")[1]);
            },
            success: function(data) {
                isDel = true;
                $jModalDelete.modal('hide');
            }
        })
    });

    var getTitle = function(data) {
        var temp = [];
        var t1 = parseInt((new Date).getTime() / 1e3, 10);
        var t2 = parseInt(data.expire, 10);
        var t = t2 - t1;

        if (!data.expire) {
            temp.push('<div class="fl"><span class="blue">等待报价</span></div>');
            temp.push('<div class="fr">常年采购</div>');

        } else if (data.status === 0 || t < 0) {
            temp.push('<div class="fl"><span class="gray">关闭</span></div>');
            temp.push('<div class="fr">', timeago.shortDate(parseInt(data.expire, 10) * 1e3), ' 截止</div>');

        } else {
            var d = (t/60/60/24) | 0;
            var h = (t/60/60%24) | 0;
            var m = (t/60%60) | 0;
            var txt = '';

            if (d > 0) {
                txt = '<b>' + d + '</b>天';
            } else if (h > 0) {
                txt = '<b>' + h + '</b>时';
            } else if (m > 0) {
                txt = '<b>' + m + '</b>分';
            } else {
                txt = '<b>' + d + '</b>天';
            }

            temp.push('<div class="fl"><span class="blue">等待报价</span></div>');
            temp.push('<div class="fr">剩余', txt, '(', timeago.shortDate(parseInt(data.expire, 10) * 1e3), ' 截止)</div>');
        }
        return temp.join('');
    }
    var getDD = function(data) {
        var temp = [];
        $.each(data, function(i, item) {
            var num = item.quotecount === 0 ? '暂无报价' : item.quotecount + '个报价' + (item.unreply === 0 ? '' : '(<em>' + item.unreply + '</em>个未答复)');
            temp.push('<dd>');
            temp.push(    '<a', (item.unreply === 0 ? '' : ' class="unreply"'), ' href="/replydetail?pid=', item.id, '">');
            temp.push(         '<span class="w1">', item.name, '</span>');
            temp.push(         '<span class="w2">', item.specification, '</span>');
            temp.push(         '<span class="w3">', num, '</span>');
            temp.push(         '<i class="iconfont icon-more arrow"></i>');
            temp.push(    '</a>');
            temp.push('</dd>');
        });
        return temp.join('');
    }
    var getFoot = function(data) {
        if (data.status === 0) {
            return '';
        }
        var temp = [];
        temp.push('<div class="tools cf">');
        temp.push(  '<span class="fl" pid="', data.id, '"><a href="#"><i class="iconfont icon-close"></i>关闭采购单</a></span>');
        temp.push(  '<span class="fr"><a href="/purchaseinfobatch/purchaseid/', data.id, '"><i class="iconfont icon-share"></i>查看/分享采购单</a></span>');
        temp.push('</div>');
        return temp.join('');
    }

    var toHtml = function(data) {
        var html = [];
        for (var i = 0; i < data.length; i++) {
            var status = '<div class="status status-refuse"><i class="iconfont icon-frown"></i></div>'
            var temp = [];
            temp.push('<li>');
            temp.push(     '<dl>');
            temp.push(         '<dt class="yc-sub-title">');
            temp.push(             '<div class="cf">');
            temp.push(                  '<div class="fl">采购批次号：<span>', data[i].id, '</span></div>');
            temp.push(                  '<div class="fr"><time>', timeago.fullTime(parseInt(data[i].createtime, 10) * 1e3), '</time></div>');
            temp.push(             '</div>');
            temp.push(             '<div class="cf">');
            temp.push(                  getTitle(data[i]));
            temp.push(             '</div>');
            temp.push(         '</dt>');
            temp.push(         getDD(data[i].purchaseinfo));
            temp.push(     '</dl>');
            temp.push(     getFoot(data[i]));
            temp.push('</li>');
            html.push(temp.join(''));
        }
        return html.join('');
    }
    // dropload
    var $ol = $('.yc-reply-list ul');
    $ol.parent().dropload({
        scrollArea : window,
        loadUpFn : function(me){
            $.ajax({
                type: 'post',
                url: '/reply',
                dataType: 'json',
                beforeSend: function(jqXHR, settings) {
                    jqXHR.setRequestHeader('X-Xsrftoken', document.cookie.match("\\b_xsrf=([^;]*)\\b")[1]);
                },
                success: function(data){
                    if (!data.list) {
                        return false;
                    }
                    me.unlock();
                    me.isDate = true;
                    var result = toHtml(data.list);
                    $ol.html(result);
                    var msg = Math.random() > .5 ? '暂无新的采购单推荐' : '药材购为您新推荐5个采购单'; // 随机显示2种提示语，只做演示使用
                    me.$domUp.html('<div class="dropload-msg">' + msg + '</div>');
                    me.resetload();
                },
                error: function(xhr, type){
                    lpPopover('网络连接超时，请您稍后重试!');
                    // 即使加载出错，也得重置
                    me.resetload();
                }
            });
        },
        loadDownFn : function(me){
            $.ajax({
                type: 'post',
                url: '/reply?number=' + $ol.children().length,
                dataType: 'json',
                beforeSend: function(jqXHR, settings) {
                    jqXHR.setRequestHeader('X-Xsrftoken', document.cookie.match("\\b_xsrf=([^;]*)\\b")[1]);
                },
                success: function(data){
                    if(data.status === 'nomore'){
                        // 锁定
                        me.lock();
                        // 无数据
                        me.noData();
                        me.resetload();
                        lpPopover(data.message);
                        return;
                    }
                    if (!data.list) {
                        return false;
                    }
                    $ol.append(toHtml(data.list));
                    // 每次数据加载完，必须重置
                    me.resetload();
                },
                error: function(xhr, type){
                    lpPopover('网络连接超时，请您稍后重试!');
                    // 即使加载出错，也得重置
                    me.resetload();
                }
            });
        },
        threshold : 50
    });
})

</script>
{% end %}