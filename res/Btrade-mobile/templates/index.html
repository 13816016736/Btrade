{% extends "base.html" %}
{% block container %}
<section class="yc-content">
    <div class="yc-tag-list">
        <h2 class="hd"><i class="iconfont icon-heart"></i>我关注了</h2>
        <ul class="bd">
            {% for variety in varieties %}
            <li><span>{{ variety.name }}</span></li>
            {% end %}
            <li><a href="/user/attention"><i class="iconfont icon-plus"></i></a></li>
        </ul>
    </div>

    <div class="yc-tag-list">
        <h2 class="hd"><i class="iconfont icon-plane"></i>我报过价</h2>
        <ul class="bd">
            <li><span>黄芪</span></li>
            <li><span>当归</span></li>
            <li><span>白芍</span></li>
        </ul>
    </div>

    <div class="yc-purchase">
        <h2 class="title">为您精选采购单，赶紧报价吧</h2>
        <div class="list">
            <ul>
                {% for purchase in purchases%}
                <li>
                    <div class="hd">
                        <h3 class="company">
                            <i class="iconfont icon-user"></i>
                            <span>{{purchase.nickname}}</span>
                            <i class="iconfont icon-radio-yes"></i>
                        </h3>
                        <div class="category">{% if purchase.type == 1 %}个人采购{% else %}饮片厂采购{% end %}</div>
                    </div>
                    {% for purchaseinfo in purchase.purchaseinfo%}
                    <a href="/purchase/purchaseinfo/{{purchaseinfo.id}}">
                    <div class="bd">
                        <h4 class="name"><i class="iconfont icon-arrow-right"></i>{{purchaseinfo.name}}</h4>
                        <div class="tag">{{purchaseinfo.specification}} {{purchaseinfo.origin}}</div>
                        <div class="weight">{{purchaseinfo.quantity}}公斤</div>
                        <div class="desc">
                            <p class="thumb"><img src="{{purchaseinfo.attachments}}" data-src="{{purchaseinfo.attachments}}" alt=""></p>
                            <p>{{purchaseinfo.quality}}</p>
                        </div>
                    </div>
                    <div class="ft">
                        {% if purchase.status == 0%}
                        <div class="status">关闭</div>
                        {% elif (purchase.limited == 1 and purchase.has_key("timedelta") and purchase.timedelta > 0) or purchase.limited == 2%}
                        {% if purchase.limited == 1%}
                        <div class="status"><span class="blue">等待报价</span>（已有<b>5</b>个报价）</div>
                        <div class="time"><i class="iconfont icon-time"></i>剩余<b>{{purchase.timedelta}}</b>天</div>
                        {% else %}
                        <div class="status"><span class="blue">常年采购</span></div>
                        {% end %}
                        {% else %}
                        <div class="status"><span class="red">报价完成</span>（已有<b>5</b>个报价）</div>
                        <div class="time high"><i class="iconfont icon-time"></i>剩余<b>{{purchase.timedelta}}</b>天</div>
                        {% end %}
                    </div>
                    </a>
                    {% end %}
                </li>
                {% end %}
                <li>
                    <a href="/purchase">
                        <div class="hd">
                            <h3 class="company">
                                <i class="iconfont icon-user"></i>
                                <span>王老板</span>
                            </h3>
                            <div class="category">个人采购</div>
                        </div>
                        <div class="bd">
                            <h4 class="name"><i class="iconfont icon-arrow-right"></i>黄连</h4>
                            <div class="tag">鸡爪统 重庆</div>
                            <div class="weight">3000公斤</div>
                            <div class="desc">
                                <p>2010药典标准，无虫蛀，无霉，无变色，硫不超标2010药典标准，无虫蛀，无霉，无变色，硫不超标2010药典标准，无虫蛀，无霉，无变</p>
                            </div>
                        </div>
                        <div class="ft">
                            <div class="status"><span class="red">报价完成</span>（已有<b>5</b>个报价）</div>
                            <div class="time high"><i class="iconfont icon-time"></i>剩余<b>1</b>天</div>
                        </div>
                    </a>
                </li>
                <li>
                    <a href="/purchase">
                        <div class="hd">
                            <h3 class="company">
                                <i class="iconfont icon-user"></i>
                                <span>葵花药业</span>
                            </h3>
                            <div class="category">药厂采购</div>
                        </div>
                        <div class="bd">
                            <h4 class="name"><i class="iconfont icon-arrow-right"></i>黄连</h4>
                            <div class="tag">鸡爪统 重庆</div>
                            <div class="weight">3000公斤</div>
                            <div class="desc">
                                <p class="thumb"><img src="static/uploads/001.jpeg" data-src="static/uploads/bing-1.jpg" alt=""></p>
                                <p>2010药典标准，无虫蛀，无霉，无变色，硫不超标2010药典标准，无虫蛀，无霉，无变色，硫不超标2010药典标准，无虫蛀，无霉，无变</p>
                            </div>
                        </div>
                        <div class="ft">
                            <div class="status"><span class="blue">等待报价</span>（已有<b>5</b>个报价）</div>
                            <div class="time"><i class="iconfont icon-time"></i>剩余<b>30</b>天</div>
                        </div>
                    </a>
                </li>
                <li>
                    <a href="/purchase">
                        <div class="hd">
                            <h3 class="company">
                                <i class="iconfont icon-user"></i>
                                <span>葵花药业</span>
                            </h3>
                            <div class="category">药厂采购</div>
                        </div>
                        <div class="bd">
                            <h4 class="name"><i class="iconfont icon-arrow-right"></i>黄连</h4>
                            <div class="tag">鸡爪统 重庆</div>
                            <div class="weight">3000公斤</div>
                            <div class="desc">
                                <p class="thumb"><img src="static/uploads/001.jpeg" data-src="static/uploads/bing-2.jpg" alt=""></p>
                                <p>2010药典标准，无虫蛀，无霉，无变色，硫不超标2010药典标准，无虫蛀，无霉，无变色，硫不超标2010药典标准，无虫蛀，无霉，无变</p>
                            </div>
                        </div>
                        <div class="ft">
                            <div class="status"><span class="blue">等待报价</span></div>
                            <div class="time"><i class="iconfont icon-time"></i>剩余<b>30</b>天</div>
                        </div>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</section><!-- /yc-content -->
<script>
$(function(){
    // 状态及文本颜色，后台返回的0或者1,0表示等待报价，字体颜色为蓝色；1表示报价完成，字体颜色为红色。
    var getStatus = {
        txt: ['关闭','等待报价', '报价完成'],
        col: ['red', 'blue', 'red']
    }
    var toHtml = function(data) {
        var html = [];
        for (var i = 0; i < data.length; i++) {
            var temp = [];
            temp.push('<li>');
            temp.push( '<div class="hd">');
            temp.push(    '<h3 class="company">');
            temp.push(         '<i class="iconfont icon-user"></i>');
            temp.push(         '<span>' + data[i].nickname + '</span>');
            temp.push(     '</h3>');
            temp.push( '<div class="category">' + (data[i].type == 1) ? " 个人采购." : " 饮片厂采购" + '</div>');
            temp.push( '</div>');

            for (var j = 0; j < data[i].purchaseinfo.length; j++) {
                temp.push( '<a href=/purchase/purchaseinfo/' + data[i].purchaseinfo[j].id + '>');
                temp.push(     '<div class="bd">');
                temp.push(         '<h4 class="name"><i class="iconfont icon-arrow-right"></i>' + data[i].purchaseinfo[j].name + '</h4>');
                temp.push(         '<div class="tag">' + data[i].purchaseinfo[j].specification + " " + data[i].purchaseinfo[j].origin + '</div>');
                temp.push(         '<div class="weight">' + data[i].purchaseinfo[j].quantity + '公斤</div>');
                temp.push(         '<div class="desc">');
                data[i].purchaseinfo[j].attachments&&temp.push( '<p class="thumb"><img src="' + data[i].purchaseinfo[j].attachments + '" alt=""></p>');
                temp.push(             '<p>' + data[i].purchaseinfo[j].quality + '</p>');
                temp.push(         '</div>');
                temp.push(     '</div>');
                temp.push(     '<div class="ft">');
                if(data[i].purchaseinfo[j].status == 0){
                    temp.push(         '<div class="status">');
                    temp.push(              '<span class="' + getStatus.col[data[i].status] + '">' + getStatus.txt[data[i].status] + '</span>');
                    temp.push( '（已有<b>5</b>个报价）');
                    temp.push(         '</div>');
                    temp.push(         '<div class="time' + (data[i].time === 1 ? ' high' : '') + '"><i class="iconfont icon-time"></i>剩余<b>' + data[i].time + '</b>天</div>');
                }else if((data[i].purchaseinfo[j].limited == 1 && data[i].purchaseinfo[j].hasOwnProperty("timedelta") && data[i].purchaseinfo[j].timedelta > 0) || data[i].purchaseinfo[j].limited == 2){
                    if(data[i].purchaseinfo[j].limited == 1){
                        temp.push(         '<div class="status">');
                        temp.push(              '<span class="blue">等待报价</span>');
                        temp.push( '（已有<b>5</b>个报价）');
                        temp.push(         '</div>');
                        temp.push(         '<div class="time' + (data[i].purchaseinfo[j].timedelta === 1 ? ' high' : '') + '"><i class="iconfont icon-time"></i>剩余<b>' + data[i].purchaseinfo[j].timedelta + '</b>天</div>');
                    }else{
                        temp.push(         '<div class="status">');
                        temp.push(              '<span class="blue">常年采购</span>');
                        temp.push(         '</div>');
                    }
                }else{
                    temp.push(         '<div class="status">');
                    temp.push(              '<span class="red">报价完成</span>');
                    temp.push( '（已有<b>5</b>个报价）');
                    temp.push(         '</div>');
                    temp.push(         '<div class="time' + (data[i].purchaseinfo[j].timedelta === 1 ? ' high' : '') + '"><i class="iconfont icon-time"></i>剩余<b>' + data[i].purchaseinfo[j].timedelta + '</b>天</div>');
                }
                temp.push(     '</div>');
                temp.push( '</a>');
            }

            temp.push('</li>');
            html.push(temp.join(''));
        }
        return html.join('');
    }
    // dropload
    $('.list').dropload({
        scrollArea : window,
        domUp : {
            domClass   : 'dropload-up',
            domRefresh : '<div class="dropload-refresh">↓下拉刷新-自定义内容</div>',
            domUpdate  : '<div class="dropload-update">↑释放更新-自定义内容</div>',
            domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中-自定义内容...</div>'
        },
        domDown : {
            domClass   : 'dropload-down',
            domRefresh : '<div class="dropload-refresh">↑上拉加载更多-自定义内容</div>',
            domLoad    : '<div class="dropload-load"><span class="loading"></span>加载中-自定义内容...</div>',
            domNoData  : '<div class="dropload-noData">暂无数据-自定义内容</div>'
        },
        loadUpFn : function(me){
            $.ajax({
                type: 'GET',
                url: 'json/update.json',
                dataType: 'json',
                success: function(data){
                    if (!data.list) {
                        return false;
                    }
                    var result = toHtml(data.list);
                    // 为了测试，延迟1秒加载
                    setTimeout(function(){
                        $('.list ul').html(result);
                        // 每次数据加载完，必须重置
                        // me.resetload();
                        var msg = Math.random() > .5 ? '暂无新的采购单推荐' : '药材购为您新推荐8个采购单'; // 随机显示2种提示语，只做演示使用
                        me.$domUp.html('<div class="dropload-msg">' + msg + '</div>');
                        setTimeout(function(){
                            me.resetload();
                        }, 2e3);
                    },1000);
                },
                error: function(xhr, type){
                    lpPopover('网络连接超时，请您稍后重试!');
                    // 即使加载出错，也得重置
                    me.resetload();
                }
            });
        },
        loadDownFn : function(me){
            $.ajax({
                type: 'GET',
                url: '/purchase/purchaselist/number/'+$(".list li").length,
                dataType: 'json',
                method: 'post',
                beforeSend: function(jqXHR, settings) {
                    jqXHR.setRequestHeader('X-Xsrftoken', document.cookie.match("\\b_xsrf=([^;]*)\\b")[1]);
                },
                success: function(data){
                    if (!data.list) {
                        return false;
                    }
                    var result = toHtml(data.list);

                    if(data.status === 'nomore'){
                        // 锁定
                        me.lock();
                        // 无数据
                        me.noData();
                        return;
                    }

                    $('.list ul').append(result);
                    // 每次数据加载完，必须重置
                    me.resetload();
                },
                error: function(xhr, type){
                    lpPopover('网络连接超时，请您稍后重试11!');
                    // 即使加载出错，也得重置
                    me.resetload();
                }
            });
        },
        threshold : 50
    });

});
</script>
{% end %}