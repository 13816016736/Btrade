{% extends "base.html" %}
{% block page-wrapper %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">
                账户资料
            </h1>
            <ol class="breadcrumb">
                <li>
                    <span class="glyphicon glyphicon-dashboard" aria-hidden="true"></span>  <a href="/dashboard">我的账户</a>
                </li>
                <li class="active">
                    <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span> 子账号
                </li>
            </ol>
        </div>
    </div>
    <!-- /.row -->
    <div class="row">
        <h3>基础信息</h3>
        <hr>
        <div class="col-lg-10">
            <form role="form" id="user_form" action="/updateuser">
                <div class="form-group">
                    <label class="control-label col-md-2">会员名</label>
                    <div class="form-inline">
                        {{ user.username }} （编号：{{ user.id }}）
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-2">密码</label>
                    <div class="form-inline"><a href="javascript:void(0)" onClick="updateinfo(this, 'password')">修改密码</a></div>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-2">绑定手机</label>
                    <div class="form-inline">{{user.phone[0:3]}}****{{user.phone[-4:]}} <a href="javascript:void(0)" onClick="updateinfo(this, 'phone')">修改</a></div>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-2">个人称呼</label>
                    <div class="form-inline"><input class="form-control" name="nickname" value="{{user.nickname}}"></div>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-2"></label>
                    <div class="form-inline">
                    <button type="submit" class="btn btn-warning">保存基础信息</button>
                    <span id="usermsg" style="display:none"></span>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="row">
        <h3>经营主体</h3>
        <hr>
        <div class="col-lg-10">
            <form role="form" id="user_name_form" action="/updateusername">
                <div class="form-group">
                    <label class="control-label col-md-2">经营主体</label>
                    <div class="form-inline"><input class="form-control" name="name" value="{{user.name}}"></div>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-2"></label>
                    <button type="submit" class="btn btn-warning">保存经营主体信息</button>
                    <span id="usernamemsg" style="display:none"></span>
                </div>
            </form>
        </div>
    </div>
    <div class="row">
        <h3>经营信息</h3>
        <hr>
        <div class="col-lg-10">
            <form role="form" id="user_info_form" action="/updateuserinfo">
                {% if user.has_key('type') is False or (user.has_key('type') and user.get('type') in ['1','2','3','4','5']) %}
                <div class="form-group">
                    <label class="control-label col-md-2">经营类型（企业）</label>
                    <label class="radio-inline">
                        <input type="radio" name="type"{% if user.type=="1" %} checked {% end %}value="1">饮片厂/饮片生产、加工
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="type"{% if user.type=="2" %} checked {% end %}value="2">药厂/制药企业
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="type"{% if user.type=="3" %} checked {% end %}value="3">药材贸易经营公司
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="type"{% if user.type=="4" %} checked {% end %}value="4">种植合作社/种植基地
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="type"{% if user.type=="5" %} checked {% end %}value="5">其他类型公司
                    </label>
                </div>
                {% end %}
                {% if user.has_key('type') is False or (user.has_key('type') and user.get('type') in ['6','7','8','9','10']) %}
                <div class="form-group">
                    <label class="control-label col-md-2">经营类型（个人）</label>
                    <label class="radio-inline">
                        <input type="radio" name="type"{% if user.type=="6" %} checked {% end %}value="6">个人经营
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="type"{% if user.type=="7" %} checked {% end %}value="7">企业采购经理/业务员
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="type"{% if user.type=="8" %} checked {% end %}value="8">采购药材为主
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="type"{% if user.type=="9" %} checked {% end %}value="9">销售药材为主
                    </label>
                    <label class="radio-inline">
                        <input type="radio" name="type"{% if user.type=="10" %} checked {% end %}value="10">既采购也销售药材
                    </label>
                </div>
                {% end %}
                <div class="form-group">
                    <label class="control-label col-md-2">关注品种</label>
                    <div class="form-inline">
                        {% if len(varietyids) != 0 %}
                        {% for varietyid in varietyids %}
                        <input class="form-control" name="varietyid" value="{{ varietyid.name }}">
                        {% end %}
                        {% else %}
                        <input class="form-control" name="varietyid">
                        <input class="form-control" name="varietyid">
                        <input class="form-control" name="varietyid">
                        {% end %}
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-2"></label>
                    <button type="button" id="addline" class="btn btn-primary">添加</button>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-2">经营地</label>
                    <div class="form-inline">
                        <select id="province" name="province" class="form-control">
                        <option value="">省</option>
                        {% for province in provinces %}
                        <option value="{{province.id}}"{% if area and (area.parentid == province.id)%} selected {%end%}>{{province.areaname}}</option>
                        {% end %}
                        </select>
                        <select id="city" name="city" class="form-control" data-bv-field="city">
                        {% if user.has_key('areaid') and area%}
                        {% for c in city %}
                        <option value="{{c.id}}"{% if area.id == c.id%} selected {%end%}>{{c.areaname}}</option>
                        {% end %}
                        {% else %}
                        <option value="">市/县</option>
                        {% end %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-md-2"></label>
                    <button type="submit" class="btn btn-warning">保存经营信息</button>
                    <span id="userinfomsg" style="display:none"></span>
                </div>
            </form>
        </div>
    </div>
</div>
<script type="text/javascript">
$(document).ready(function(){
    $("#province").change(function(){
        var provinceid = $("#province").val();
        var _xsrf = document.cookie.match("\\b_xsrf=([^;]*)\\b")[1];
        if(provinceid == "")
            return;
        $.ajax({
            url: "/getcity",
            data: "&_xsrf=" + _xsrf + "&provinceid=" + provinceid,
            dataType: 'json',
            type: 'POST',
            success: function(data) {
                if(data.status == "success"){
                    $("#city").empty();
                    cities = eval(data.data);
                    for(var i=0; i<cities.length; i++){
                       $("#city").append("<option value=\"" + cities[i].id +"\">" + cities[i].areaname + "</option>");
                    }
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                alert(errorThrown);
            }
         });
     });
     $('#user_form').submit(function(e) {
         e.preventDefault();
         var $form = $(e.target);
         var bv = $form.data('bootstrapValidator');
         $.ajax({
            url: $(this).attr('action'),
            data: $(this).serialize(),
            dataType: 'json',
            type: 'POST',
            beforeSend: function(jqXHR, settings) {
                jqXHR.setRequestHeader('X-Xsrftoken', document.cookie.match("\\b_xsrf=([^;]*)\\b")[1]);
            },
            success: function(data) {
                if(data.status == "success"){
                    $("#usermsg").html("<span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span>"+data.message);
                    $("#usermsg").show();
                }else{
                    $("#usermsg").html("<span class=\"glyphicon glyphicon-remove\" aria-hidden=\"true\"></span>"+data.message);
                    $("#usermsg").show();
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log(errorThrown);
            }
         });
     });
     $('#user_name_form').submit(function(e) {
         e.preventDefault();
         $.ajax({
            url: $(this).attr('action'),
            data: $(this).serialize(),
            dataType: 'json',
            type: 'POST',
            beforeSend: function(jqXHR, settings) {
                jqXHR.setRequestHeader('X-Xsrftoken', document.cookie.match("\\b_xsrf=([^;]*)\\b")[1]);
            },
            success: function(data) {
                if(data.status == "success"){
                    $("#usernamemsg").html("<span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span>"+data.message);
                    $("#usernamemsg").show();
                }else{
                    $("#usernamemsg").html("<span class=\"glyphicon glyphicon-remove\" aria-hidden=\"true\"></span>"+data.message);
                    $("#usernamemsg").show();
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log(errorThrown);
            }
         });
     });
     $('#user_info_form').submit(function(e){
         e.preventDefault();
         $.ajax({
            url: $(this).attr('action'),
            data: $(this).serialize(),
            dataType: 'json',
            type: 'POST',
            beforeSend: function(jqXHR, settings) {
                jqXHR.setRequestHeader('X-Xsrftoken', document.cookie.match("\\b_xsrf=([^;]*)\\b")[1]);
            },
            success: function(data) {
                if(data.status == "success"){
                    $("#userinfomsg").html("<span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span>"+data.message);
                    $("#userinfomsg").show();
                }else{
                    $("#userinfomsg").html("<span class=\"glyphicon glyphicon-remove\" aria-hidden=\"true\"></span>"+data.message);
                    $("#userinfomsg").show();
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                console.log(errorThrown);
            }
         });
     });
     $("#addline").click(function(){
        $(this).parent().before("<div class=\"form-group\">"+
                    "<label class=\"control-label col-md-2\"></label>"+
                    "<div class=\"form-inline\">"+
                        "<input class=\"form-control\" name=\"varietyid\"> " +
                        "<input class=\"form-control\" name=\"varietyid\"> " +
                        "<input class=\"form-control\" name=\"varietyid\"> " +
                    "</div></div>");
     });
});
function updateinfo(obj, name){
    if(name=="password"){
        obj.parentNode.innerHTML = "<input class=\"form-control\" placeholder=\"旧密码\" type=\"password\" name=\"oldpassword\" />  " +
        "<input class=\"form-control\" placeholder=\"新密码\" type=\"password\" name=\"" + name + "\" />";
    }else if(name == "phone"){
        obj.parentNode.innerHTML = "<input class=\"form-control\" placeholder=\"旧手机号\" type=\"text\" "+
        "name=\"oldphone\" />  <input class=\"form-control\" placeholder=\"新手机号\" type=\"text\" name=\"" + name + "\" /> " +
        " <input class=\"form-control\" placeholder=\"短信验证码\" type=\"text\" name=\"verifycode\" /> " +
        " <button type=\"button\" class=\"btn btn-primary\" onclick=\"time(this)\">获取短信验证码</button>";
    }
}
var wait = 60;
function time(o) {
    if (wait == 60) {
    //ajax发送短信
    }
    if (wait == 0) {
        o.removeAttribute("disabled");
        o.innerHTML="获取短信验证码";
        wait = 60;
    } else {
        o.setAttribute("disabled", true);
        o.innerHTML="重新发送(" + wait + ")";
        wait--;
        setTimeout(function() {
            time(o)
        },
        1000)
    }
}
</script>
{% end %}